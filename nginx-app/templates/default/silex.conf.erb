upstream phpfpm {
    server  unix:/var/run/php-fpm/<%= @php_user %>;
}

server {
    listen 80;

    index <%=@default_router%>;

<% if @xhprof_enable -%>
    location /xhprof {
        # drop location to serve assets
        alias <%=node["xhprof.io"]["root"] %>;

        # serve PHP files from xhprof.io
        location ~* \.php$ {
            root          <%=node["xhprof.io"]["root"] %>/;
            fastcgi_index index.php;
            fastcgi_pass  phpfpm;
            include       fastcgi_params;
            fastcgi_param SCRIPT_FILENAME <%=node["xhprof.io"]["root"] %>/index.php;
            fastcgi_param SCRIPT_NAME     $fastcgi_script_name;
            fastcgi_param PHP_ADMIN_VALUE "short_open_tag=On";
        }
    }
<%- end %>

    location = / {
        try_files @site @site;
    }

    #all other locations try other files first and go to our front controller if none of them exists
    location / {
        try_files $uri $uri/ @site;
    }

    root <%= @doc_root%>;

    location ~* \.php$ {
        fastcgi_index index.php;
        fastcgi_pass  phpfpm;
        include       fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME     $fastcgi_script_name;

<% if @xhprof_enable -%>
        set $php_value "auto_prepend_file=<%=node["xhprof.io"]["root"] %>/inc/prepend.php";
        set $php_value "$php_value \n auto_append_file=<%=node["xhprof.io"]["root"] %>/inc/append.php";
        fastcgi_param PHP_VALUE $php_value;
<% end -%>
    }

    location @site {
            fastcgi_pass  phpfpm;
            include       fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root/<%=@default_router%>;

            set $php_value "auto_prepend_file=<%=node["xhprof.io"]["root"] %>/inc/prepend.php";
            set $php_value "$php_value \n auto_append_file=<%=node["xhprof.io"]["root"] %>/inc/append.php";
            fastcgi_param PHP_VALUE $php_value;
    }
}
