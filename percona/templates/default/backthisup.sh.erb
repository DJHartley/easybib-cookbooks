#!/usr/bin/env python

import getpass, glob, os, sys, tarfile

store='<%= node[:xtrabackup][:dir]} %>'

if os.path.exists(store) is False:
    print "Backup location (%s) does not exist." % store
    sys.exit(1)

if os.access(store, os.W_OK) is False:
    print "Backup location ({0}) is not writable by: {1}".format(store, getpass.getuser())
    sys.exit(1)

dirs = glob.glob(store + '/*')

for d in dirs:
    if os.path.isdir(d) is False:
        continue

    if os.path.exists(d + '.tar.bz2'):
        print '%s is already processed.' % d

    if os.path.exists(d + '.tar'):
        os.remove(d + '.tar')

    tar = tarfile.open(d + '.tar.bz2', 'w:bz2')
    tar.add(d)
    tar.close()

    print 'Processed %s' % d

sys.exit(0)
