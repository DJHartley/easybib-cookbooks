#!/bin/sh

export PATH=/bin:/usr/bin:/usr/local/bin

SQLHOST='<%= node["rdsbackup"]["sqlhost"] %>'
SQLUSER='<%= node["rdsbackup"]["sqluser"] %>'
SQLPASS='<%= node["rdsbackup"]["sqlpass"] %>'

S3BUCKET='<%= node["rdsbackup"]["s3bucket"] %>'
S3ACCESSKEYID='<%= node["rdsbackup"]["s3accesskeyid"] %>'
S3SECRETACCESSKEY='<%= node["rdsbackup"]["s3secretaccesskey"] %>'

BACKUPFILE="sqlback-`date '+%Y%m%d%H%M'`.sql"

cd /tmp
mysqldump -h "$SQLHOST" -u "$SQLUSER" -p"$SQLPASS" --all-databases > $BACKUPFILE
bzip2 --best $BACKUPFILE
/usr/local/bin/s3uploadfix.sh --bucket "$S3BUCKET" --accesskeyid "$S3ACCESSKEYID" --secretaccesskey "$S3SECRETACCESSKEY" ${BACKUPFILE}.bz2
rm -f sqlback-*
